<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>Checkout | Legend Motor Limited</title>
    <meta name="author" content="Legend Motor Limited"/>
    <meta name="robots" content="noindex, nofollow"/>
    <link rel="icon" href="../../../resources/image/icon.png" type="image/x-icon"/>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="../../../resources/css/insurance_customer_style.css">
    <script src="../../../resources/js/customer.js"></script>
    <!-- <script src="../../../resources/js/script.js"></script> -->
    <link rel="stylesheet" href="../../../resources/css/horizon_menu_bar.css">
</head>
<script>
    function showLeaveConfirmation(destinationUrl) {
        const popup = document.createElement('div');
        popup.className = 'popup-overlay';
        popup.style.display = 'flex';

        popup.innerHTML = `
            <div class="popup-content">
                <h2>Save Your Progress?</h2>
                <p><strong>Would you like to save your application progress before leaving? Saved applications are retained for one week.</strong></p>
                <div class="popup-buttons">
                    <button class="popup-button save-button" onclick="saveAndLeave('${destinationUrl}')">
                        Save & Leave
                    </button>
                    <button class="popup-button leave-button" onclick="leavePage('${destinationUrl}')">
                        Leave Without Saving
                    </button>
                    <button class="popup-button stay-button" onclick="stayOnPage()">
                        Stay on Page
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(popup);
        setTimeout(() => popup.classList.add('show'), 10);

        const style = document.createElement('style');
        style.textContent = `
            .save-notice { color: #666; font-size: 0.9rem; margin-top: 0.5rem; }
            .popup-buttons { display: flex; flex-direction: column; gap: 1rem; margin-top: 2rem; }
            .popup-button { display: flex; flex-direction: column; align-items: center; padding: 1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; width: 100%; }
            .popup-button small { font-size: 0.8rem; font-weight: normal; margin-top: 0.25rem; opacity: 0.8; }
            .save-button { background-color: #4CAF50; color: white; }
            .leave-button { background-color: #f44336; color: white; }
            .stay-button { background-color: #00bcd4; color: white; }
        `;
        document.head.appendChild(style);
    }

    function saveAndLeave(destinationUrl) {
        const formData = {
            timestamp: new Date().getTime(),
            expiryDate: new Date().getTime() + (7 * 24 * 60 * 60 * 1000),
            data: {
                Save_selected_option: localStorage.getItem('Save_selected_option'),
                Save_selected_option_2: localStorage.getItem('Save_selected_option_2'),
                Save_selected_option_3: localStorage.getItem('Save_selected_option_3')
            }
        };
        localStorage.setItem('savedApplication', JSON.stringify(formData));
        leavePage(destinationUrl);
    }

    function generateReferenceNumber() {
        const timestamp = new Date().getTime();
        return `LMC-${timestamp}`;
    }

    function stayOnPage() {
        const popup = document.querySelector('.popup-overlay');
        popup.classList.remove('show');
        setTimeout(() => popup.remove(), 300);
    }

    function leavePage(destinationUrl) {
        window.location.href = destinationUrl;
        localStorage.removeItem('Save_selected_option');
        localStorage.removeItem('Save_selected_option_2');
        localStorage.removeItem('Save_selected_option_3');
        localStorage.removeItem('editMode');
        localStorage.removeItem('editData');
        localStorage.removeItem('editOrderId');
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('editID').innerHTML = 'Applicant: ' + localStorage.getItem('editOrderId');

        const inputs = document.querySelectorAll('input, select, textarea, button');
        inputs.forEach(input => {
            if (input.id !== 'excess3' && input.id !== 'excess2' && input.id !== 'discountDescription') {
                const editOrderId = localStorage.getItem('editOrderId');
                const pendingInsurance = JSON.parse(localStorage.getItem(`pendingInsurance-${editOrderId}`));
                input.disabled = true;
                document.getElementById('excess2').value = pendingInsurance.discount;
                document.getElementById('excess3').value = pendingInsurance.raisePrice;
                document.getElementById('discountDescription').value = "DEMO";
            }
        });

        if (localStorage.getItem('editMode') == 'check') {
            document.getElementById('editDetail').style.display = 'none';
            document.getElementById('buy-button').style.display = 'none';
            document.getElementById('uploadRecord').innerText = 'Download Certificates of Traffic Conviction Records';

            const inputs = document.querySelectorAll('input, select, textarea, button');
            inputs.forEach(input => input.disabled = true);
        }

        document.getElementById('email').value = localStorage.getItem('loginUser');
        const links = document.querySelectorAll('a:not([href="process.html"])');
        links.forEach(link => {
            link.addEventListener('click', function(e) {
                const isSpecialButton = e.target.classList.contains('buy-button') ||
                    e.target.classList.contains('estimate-button') ||
                    e.target.id === 'btn_quote';

                if (!isSpecialButton) {
                    e.preventDefault();
                    showLeaveConfirmation(this.getAttribute('href'));
                }
            });
        });

        const estimateButton = document.getElementById('btn_quote');
        if (estimateButton) {
            estimateButton.addEventListener('click', function() {
                save_selected_option();
                window.location.href = 'estimate.html';
            });
        }

        const savedApplication = localStorage.getItem('savedApplication');
        if (savedApplication) {
            const { expiryDate } = JSON.parse(savedApplication);
            if (Date.now() > expiryDate) {
                localStorage.removeItem('savedApplication');
            }
        }
    });
    function validateAdditionalDrivers() {
        const numDrivers = parseInt(document.getElementById('insuredDrivers').value);
        if (numDrivers <= 1) return true;

        for (let i = 1; i < numDrivers; i++) {
            const driverFields = [
                `driver-${i}-title`,
                `driver-${i}-firstName`,
                `driver-${i}-lastName`,
                `driver-${i}-hkid`,
                `driver-${i}-dob`,
                `driver-${i}-occupation`,
                `-${i}-DrivingExperience`,
                `driver-${i}-relation`
            ];

            for (const fieldId of driverFields) {
                const field = document.getElementById(fieldId);
                if (!field || !validateField(field)) {
                    return false;
                }
            }
        }
        return true;
    }

    function validateForm() {
        const requiredFields = document.querySelectorAll('input[required], select[required]');
        const buyButton = document.querySelector('.buy-button');
        let isValid = true;
        let hasEmptyRequired = false;
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                hasEmptyRequired = true;
                field.classList.add('invalid');
                field.classList.remove('valid');
                field.title = MESSAGES.required;
            }
        });

        requiredFields.forEach(field => {
            if (!validateField(field)) {
                isValid = false;
            }
        });

        if (!validateAddress()) {
            isValid = false;
        }

        if (!validateAdditionalDrivers()) {
            isValid = false;
        }

        const licensePlateField = document.getElementById('registrationNumber');
        if (licensePlateField && licensePlateField.value) {
            const value = licensePlateField.value.toUpperCase();
            if (PATTERNS.licensePlate.test(value)) {
                const formatted = value.replace(/^([A-Z]{1,2})([0-9])/, '$1 $2');
                licensePlateField.value = formatted;
            }
        }
        const shouldEnableButton = isValid && !hasEmptyRequired;
        buyButton.disabled = !shouldEnableButton;
        buyButton.style.opacity = shouldEnableButton ? '1' : '0.5';
        buyButton.style.cursor = shouldEnableButton ? 'pointer' : 'not-allowed';

        return shouldEnableButton;
    }

    function addValidationListeners(field) {
        ['input', 'change', 'blur', 'keyup'].forEach(eventType => {
            field.addEventListener(eventType, () => {
                validateField(field);
                validateForm();
            });
        });
    }

    $(document).ready(function() {
        const allFields = document.querySelectorAll('input, select');
        allFields.forEach(field => addValidationListeners(field));

        const numDrivers = parseInt(Save_selected_option_2.insuredDrivers);
        if (numDrivers > 1  && localStorage.getItem('editMode') !== 'true') {
            const driversContainer = $('#driversContainer');
            for (let i = 1; i < numDrivers; i++) {
                driversContainer.append(createDriverForm(i));
            }
            driversContainer.find('input, select').each(function() {
                addValidationListeners(this);
            });
        }
        validateForm();

    });

    const PATTERNS = {
        email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
        hkid: /^[A-Z]{1,2}[0-9]{6}([0-9A])?$/,
        mobile: /^[0-9]{8}$/,
        licensePlate: /^[A-Z]{1,2}\s?[0-9]{1,4}$/,
        buildingName: /^[\w\s\-.']{2,50}$/,
        street: /^[\w\s\-.']{2,50}$/,
        room: /^[\w\-]{1,10}$/,
        floor: /^[\w\-]{1,10}$/,
        block: /^[\w\-]{1,10}$/
    };

    const MESSAGES = {
        email: "Please enter a valid email address",
        hkid: "Please enter a valid HKID (e.g., A123456)",
        mobile: "Please enter a valid 8-digit mobile number",
        licensePlate: "Please enter a valid HK license plate (e.g., AA 1234)",
        buildingName: "Building name must be between 2 and 50 characters",
        street: "Street name must be between 2 and 50 characters",
        room: "Room number is required",
        floor: "Floor number is required",
        block: "Block number is required",
        required: "This field is required"
    };

    function validateField(field) {
        const value = field.value.trim();
        let isValid = true;
        let message = "";

        if (field.hasAttribute('required') && !value) {
            isValid = false;
            message = MESSAGES.required;
        } else if (value) {
            if (field.id.includes('-hkid')) {
                isValid = PATTERNS.hkid.test(value);
                message = MESSAGES.hkid;
            } else if (field.id.includes('-firstName') || field.id.includes('-lastName')) {
                isValid = value.length >= 2;
                message = "Name must be at least 2 characters long";
            } else if (field.id.includes('-dob')) {
                const dobDate = new Date(value);
                const today = new Date();
                const age = today.getFullYear() - dobDate.getFullYear();
                isValid = age >= 18;
                message = "Driver must be at least 18 years old";
            } else {
                switch (field.id) {
                    case 'email':
                        isValid = PATTERNS.email.test(value);
                        message = MESSAGES.email;
                        break;
                    case 'hkid':
                        isValid = PATTERNS.hkid.test(value);
                        message = MESSAGES.hkid;
                        break;
                    case 'mobile':
                        isValid = PATTERNS.mobile.test(value);
                        message = MESSAGES.mobile;
                        break;
                    case 'registrationNumber':
                        isValid = PATTERNS.licensePlate.test(value.toUpperCase());
                        message = MESSAGES.licensePlate;
                        break;
                    case 'excess':
                        updatePrices();
                        isValid = parseFloat(value) >= 0 && !isNaN(parseFloat(value)) && parseFloat(value) <= 50;
                        document.getElementById('excessWarning').style.display = isValid ? 'none' : 'block';
                        document.getElementById('excessWeight').innerText = isValid && parseFloat(value) > 0? 'Your total excess is ' + document.getElementById('detailExcess').innerText : "";
                        message = "Excess amount must be a positive number";
                        break;

                    case 'excess2':
                        document.getElementById('excessWeight2').style.display = parseFloat(value) >= 0 && !isNaN(parseFloat(value)) && parseFloat(value) <= 5 ? 'none' : 'block';
                        document.getElementById('discountDescription').required = parseFloat(value) >= 0 && !isNaN(parseFloat(value)) && parseFloat(value) <= 5 ? false : true;
                        break;

                    case 'excess3':
                        document.getElementById('excessWeight3').style.display = parseFloat(value) == 0 ? 'none' : 'block';
                        break;
                    case 'offence_point':
                        isValid = parseFloat(value) >= 0 && !isNaN(parseFloat(value)) && parseFloat(value) <= 15;
                        document.getElementById('offence_point_warning').style.display = isValid && parseFloat(value) > 0? 'block' : 'none';
                        message = "Offence point must be a positive number";
                        break;
                    case 'building':
                        isValid = PATTERNS.buildingName.test(value);
                        message = MESSAGES.buildingName;
                        break;
                    case 'street':
                        isValid = PATTERNS.street.test(value);
                        message = MESSAGES.street;
                        break;
                    case 'room':
                        isValid = PATTERNS.room.test(value);
                        message = MESSAGES.room;
                        break;
                    case 'floor':
                        isValid = PATTERNS.floor.test(value);
                        message = MESSAGES.floor;
                        break;
                    case 'block':
                        isValid = PATTERNS.block.test(value);
                        message = MESSAGES.block;
                        break;
                }
            }
        }

        if (!isValid) {
            field.classList.add('invalid');
            field.classList.remove('valid');
            field.title = message;
        } else {
            field.classList.remove('invalid');
            field.classList.add('valid');
            field.title = '';
        }

        if (isValid) {
            saveFormData();
        }

        return isValid;
    }

    function addValidationListeners(field) {
        ['input', 'change', 'blur'].forEach(eventType => {
            field.addEventListener(eventType, () => {
                validateField(field);
                validateForm();
            });
        });
        validateField(field);
    }
    function saveChangesAndRedirect(referenceNumber) {
        const formData = saveFormData();

        const existingData = JSON.parse(localStorage.getItem(`pendingInsurance-${referenceNumber}`));

        // Update only the form data while preserving other fields
        existingData.Save_selected_option_3 = formData;
        localStorage.setItem(`pendingInsurance-${referenceNumber}`, JSON.stringify(existingData));

        // Clear edit mode flags
        localStorage.removeItem('editMode');
        localStorage.removeItem('editOrderId');

        // Redirect back to order detail page
        window.location.href = `orderDetail.html?id=${referenceNumber}`;
    }



    function validateForm() {
        const requiredFields = document.querySelectorAll('input[required], select[required]');
        const buyButton = document.querySelector('.buy-button');
        let isValid = true;
        let hasEmptyRequired = false;

        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                hasEmptyRequired = true;
                field.classList.add('invalid');
                field.classList.remove('valid');
                field.title = MESSAGES.required;
            }
        });

        requiredFields.forEach(field => {
            if (!validateField(field)) {
                isValid = false;
            }
        });

        const shouldEnableButton = isValid && !hasEmptyRequired;
        buyButton.disabled = !shouldEnableButton;
        buyButton.style.opacity = shouldEnableButton ? '1' : '0.5';
        buyButton.style.cursor = shouldEnableButton ? 'pointer' : 'not-allowed';

        return shouldEnableButton;
    }


    // Add event listeners when document is ready
    document.addEventListener('DOMContentLoaded', function() {
        ['room', 'floor', 'block'].forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.required = true;
                field.setAttribute('placeholder', 'Required');
            }
        });
        const allFields = document.querySelectorAll('input, select');
        allFields.forEach(field => {
            ['input', 'change', 'blur', 'keyup'].forEach(eventType => {
                field.addEventListener(eventType, () => {
                    validateField(field);
                    validateForm();
                });
            });
        });
        validateForm();
    });
    let Save_selected_option = JSON.parse(localStorage.getItem("Save_selected_option"));
    let Save_selected_option_2 = JSON.parse(localStorage.getItem("Save_selected_option_2"));



    function calculateCharges(subTotal) {
        const amount = parseFloat(subTotal.replace(/[^0-9.]/g, ''));
        const insuranceLevy = amount * 0.0004;
        const mibCharge = amount * 0.0025;
        const excess = amount * (parseFloat(document.getElementById('excess').value) / 100);
        const markupPoint = amount * (parseFloat(document.getElementById('offence_point').value)/10);
        const discountByStaff = amount * (parseFloat(document.getElementById('excess2').value) / 100);

        const ncdSelect = document.getElementById('claimsDiscount');
        const raisePrice = parseFloat(document.getElementById('excess3').value);
        const ncdValue = ncdSelect.value;

        let discount = 0;

        if (ncdValue) {
            discount = amount * (parseFloat(ncdValue) / 100);
        }



        return {
            insuranceLevy: insuranceLevy.toFixed(2),
            mibCharge: mibCharge.toFixed(2),
            ncdDiscount: discount.toFixed(2),
            total: (amount + raisePrice + insuranceLevy + mibCharge - discount + markupPoint - excess - discountByStaff).toFixed(2),
            excess: excess.toFixed(2),
            markupPoint: markupPoint.toFixed(2),
            discountByStaff: discountByStaff.toFixed(2),
            raisePrice: raisePrice.toFixed(2)
        };
    }


    function updatePrices() {
        const subTotal = Save_selected_option_2.checkoutPrice;
        const charges = calculateCharges(subTotal);

        const order = JSON.parse(localStorage.getItem("pendingInsurance-" + localStorage.getItem("editOrderId")));

        // Update the display
        $('#insuranceLevy').text(order.receipt.insuranceLevy);
        $('#mibCharge').text(order.receipt.mibCharge);
        $('#totalPrice').text(order.receipt.total);
        $('#discountByStaff').text(order.discount + '%');

        $('#markupOfPoint').text(order.receipt.dop);
        $('#raisePriceByStaff').text(`HK$${charges.raisePrice}`);


        $('#ncd').text(order.receipt.ncdDiscount);
        $('#detailExcess').text(order.receipt.excess);
        $('#totalPrice').text(order.Save_selected_option_2.checkoutPrice)

    }
    document.addEventListener('DOMContentLoaded', function() {
        const ncdSelect = document.getElementById('claimsDiscount');
        const excessField = document.getElementById('excess');
        ncdSelect.addEventListener('change', updatePrices);
        excessField.addEventListener('input', updatePrices);

        updatePrices();
    });


    function calculateEndDate(startDate, paymentMethod) {

        const date = new Date(startDate);

        switch (paymentMethod) {
            case 'yearly':
                date.setFullYear(date.getFullYear() + 1);
                break;
            case 'everySixMonth':
                date.setMonth(date.getMonth() + 6);
                break;
            case 'quarterly':
                date.setMonth(date.getMonth() + 3);
                break;
            case 'monthly':
                date.setMonth(date.getMonth() + 1);
                break;
        }
        date.setDate(date.getDate() - 1);
        return date.toLocaleDateString('en-US', {
            weekday: 'short',
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });
    }

    // Format the effective date
    function formatEffectiveDate(dateString) {
        return new Date(dateString).toLocaleDateString('en-US', {
            weekday: 'short',
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });
    }

    function createDriverForm(index) {
        return `
            <div class="driver-section" id="driver-${index}">
            <hr style="margin-top: 30px; margin-bottom: 30px">
                <h1>Driver ${index + 1} Details</h1>
                <div class="form-group">
                    <div class="input-group">
                        <label for="driver-${index}-title">Title *</label>
                        <select id="driver-${index}-title" required>
                            <option value="MR">MR</option>
                            <option value="MS">MS</option>
                            <option value="MRS">MRS</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="driver-${index}-firstName">First name *</label>
                        <input type="text" id="driver-${index}-firstName" placeholder="(In English, e.g. Tai Man)" required>
                    </div>
                    <div class="input-group">
                        <label for="driver-${index}-lastName">Last name *</label>
                        <input type="text" id="driver-${index}-lastName" placeholder="(In English, e.g. Chan)" required>
                    </div>
                </div>
                <div class="form-group">
                    <div class="input-group">
                        <label for="driver-${index}-hkid">HKID Card No. *</label>
                        <input type="text" id="driver-${index}-hkid" placeholder="EG: A1234567" required>
                    </div>
                    <div class="input-group">
                        <label for="driver-${index}-dob">Date of Birth *</label>
                        <input type="date" id="driver-${index}-dob" required>
                    </div>
                </div>
                <div class="form-group">
                    <div class="input-group">
                        <label for="driver-${index}-occupation">Occupation *</label>
                        <select id="driver-${index}-occupation" required>
                            <option value="">Select occupation</option>
                                    <option value="accountant">Account/ Accountant</option>
                                    <option value="engineer">Engineer</option>
                                    <option value="teacher">Teacher</option>
                                    <option value="doctor">Doctor</option>
                                    <option value="nurse">Nurse</option>
                                    <option value="lawyer">Lawyer</option>
                                    <option value="software_developer">Software Developer</option>
                                    <option value="designer">Designer</option>
                                    <option value="salesperson">Salesperson</option>
                                    <option value="manager">Manager</option>
                                    <option value="scientist">Scientist</option>
                                    <option value="marketing_specialist">Marketing Specialist</option>
                                    <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="input-group">
                                <label for="-${index}-DrivingExperience">Driving experience *</label>
                                <select id="-${index}-DrivingExperience" required>
                                    <option value="more_than_5_years">More than 5 years</option>
                                    <option value="less_than_5_years">Less than 5 years</option>
                                    <option value="within_1_year">Started driving within 1 year</option>
                                </select>
                            </div>
                    <div class="input-group">
                        <label for="driver-${index}-occupation">Driver Relationship with Policy Holder</label>
                        <select id="driver-${index}-relation" required>
        <option value="">Select occupation</option>
        <option value="accountant">Account/ Accountant</option>
        <option value="policyholder">Policyholder</option>
        <option value="named_driver">Named Driver</option>
        <option value="main_driver">Main Driver</option>
        <option value="additional_driver">Additional Driver</option>
        <option value="temporary_driver">Temporary Driver</option>
        <option value="spouse_or_partner">Spouse or Partner</option>
        <option value="teen_driver">Teen Driver</option>
        <option value="roommate">Roommate</option>
        <option value="friend">Friend</option>
    </select>
                    </div>
                </div>
            </div>
        `;
    }

    $(document).ready(function () {

        // Update insurance type and details
        $('.insurance-type h3').text(Save_selected_option.insuranceType + ' Insurance');
        $('#planName').text('LMC ' + Save_selected_option.insuranceType);
        let paymentMethod = Save_selected_option_2.paymentMethod;
        updatePrices();
        const numDrivers = parseInt(Save_selected_option_2.insuredDrivers);
        if ((localStorage.getItem('editMode') === 'true') || (localStorage.getItem('editMode') === 'check')) {
            const savedData = JSON.parse(localStorage.getItem('Save_selected_option_3'));
            const numDrivers = savedData.additionalDrivers.length;
        }else{
            const numDrivers = parseInt(Save_selected_option_2.insuredDrivers);
        }
        const driversContainer = $('#driversContainer');
        //driversContainer.empty();

        $('#insuredDrivers').on('change', function() {
            const newNumDrivers = parseInt($(this).val());
            const driversContainer = $('#driversContainer');
            const currentDrivers = driversContainer.children().length;

            // Store existing drivers' data before making any changes
            const existingData = [];
            for (let i = 1; i <= currentDrivers; i++) {
                const driverSection = document.getElementById(`driver-${i}`);
                if (driverSection) {
                    const driverData = {
                        title: $(`#driver-${i}-title`).val(),
                        firstName: $(`#driver-${i}-firstName`).val(),
                        lastName: $(`#driver-${i}-lastName`).val(),
                        hkid: $(`#driver-${i}-hkid`).val(),
                        dob: $(`#driver-${i}-dob`).val(),
                        occupation: $(`#driver-${i}-occupation`).val(),
                        drivingExperience: $(`#-${i}-DrivingExperience`).val(),
                        relation: $(`#driver-${i}-relation`).val()
                    };
                    existingData.push(driverData);
                }
            }

            if (newNumDrivers > 1) {
                // If we're decreasing the number of drivers
                if (currentDrivers > newNumDrivers - 1) {
                    // Remove excess drivers from the end
                    for (let i = currentDrivers; i >= newNumDrivers; i--) {
                        $(`#driver-${i}`).remove();
                    }
                }
                // If we're increasing the number of drivers
                else if (currentDrivers < newNumDrivers - 1) {
                    // Keep existing drivers and add new ones
                    for (let i = currentDrivers + 1; i < newNumDrivers; i++) {
                        driversContainer.append(createDriverForm(i));

                        // Add validation to new fields
                        const driverSection = document.getElementById(`driver-${i}`);
                        if (driverSection) {
                            const fields = driverSection.querySelectorAll('input[required], select[required]');
                            fields.forEach(field => {
                                addValidationListeners(field);
                            });
                        }
                    }
                }

                // Restore data for remaining drivers
                existingData.forEach((data, index) => {
                    if (index < newNumDrivers - 1) {
                        const driverNum = index + 1;
                        const driverSection = document.getElementById(`driver-${driverNum}`);
                        if (driverSection) {
                            $(`#driver-${driverNum}-title`).val(data.title);
                            $(`#driver-${driverNum}-firstName`).val(data.firstName);
                            $(`#driver-${driverNum}-lastName`).val(data.lastName);
                            $(`#driver-${driverNum}-hkid`).val(data.hkid);
                            $(`#driver-${driverNum}-dob`).val(data.dob);
                            $(`#driver-${driverNum}-occupation`).val(data.occupation);
                            $(`#-${driverNum}-DrivingExperience`).val(data.drivingExperience);
                            $(`#driver-${driverNum}-relation`).val(data.relation);
                        }
                    }
                });
            } else {
                // If reducing to 1 driver, clear the container
                driversContainer.empty();
            }

            // If in edit mode, update the stored data
            if (localStorage.getItem('editMode') === 'true'|| (localStorage.getItem('editMode') === 'check')) {
                const savedData = JSON.parse(localStorage.getItem('Save_selected_option_3'));
                if (savedData) {
                    // Update the additionalDrivers array to match the new number of drivers
                    savedData.additionalDrivers = existingData.slice(0, newNumDrivers - 1);
                    localStorage.setItem('Save_selected_option_3', JSON.stringify(savedData));
                }
            }

            validateForm();
        });


        if (numDrivers > 1 ) {
            if(localStorage.getItem('editMode') !== 'true')
            {
                for (let i = 1; i < numDrivers; i++) {
                    //driversContainer.append(createDriverForm(i));
                    const driverSection = document.getElementById(`driver-${i}`);
                    if (driverSection && localStorage.getItem('editMode') !== 'true') {
                        const fields = driverSection.querySelectorAll('input[required], select[required]');
                        fields.forEach(field => {
                            addValidationListeners(field);
                        });
                    }
                }
            }
            if(localStorage.getItem('editMode') === 'true' || (localStorage.getItem('editMode') === 'check')) {
                const savedData = JSON.parse(localStorage.getItem('Save_selected_option_3'));
                if (savedData && savedData.additionalDrivers && savedData.additionalDrivers.length > 0) {
                    savedData.additionalDrivers.forEach((driver, index) => {
                        const driverNumber = index + 1;

                        document.getElementById(`driver-${driverNumber}-title`).value = driver.title || '';
                        document.getElementById(`driver-${driverNumber}-firstName`).value = driver.firstName || '';
                        document.getElementById(`driver-${driverNumber}-lastName`).value = driver.lastName || '';
                        document.getElementById(`driver-${driverNumber}-hkid`).value = driver.hkid || '';
                        document.getElementById(`driver-${driverNumber}-dob`).value = driver.dob || '';
                        document.getElementById(`driver-${driverNumber}-occupation`).value = driver.occupation || '';
                        document.getElementById(`-${driverNumber}-DrivingExperience`).value = driver.drivingExperience || '';
                        document.getElementById(`driver-${driverNumber}-relation`).value = driver.relation || '';
                    });
                }
                validateAdditionalDrivers();
            }
        }
        switch (paymentMethod) {
            case 'yearly':
                paymentMethod = "Yearly";
                break;
            case 'everySixMonth':
                paymentMethod = "Every Six Month";
                break;
            case 'quarterly':
                paymentMethod = "Quarterly";
                break;
            case 'monthly':
                paymentMethod = "Monthly";
                break;
        }


        // Update policy dates
        const effectiveDate = formatEffectiveDate(Save_selected_option_2.policyEffectiveDate);
        const endDate = calculateEndDate(Save_selected_option_2.policyEffectiveDate, Save_selected_option_2.paymentMethod);
        // Update policy details
        $('.policy-details').html(`
            <div class="detail-row">
                <span>Plan Name</span>
                <span>LMC ${Save_selected_option.insuranceType}</span>
            </div>
            <div class="detail-row">
                <span>Policy effective date</span>
                <span>${effectiveDate}</span>
            </div>
            <div class="detail-row">
                <span>Policy end date</span>
                <span>${endDate}</span>
            </div>
            <div class="detail-row">
                <span>Vehicle</span>
                <span>${Save_selected_option.manufacturingYear} ${Save_selected_option.carBrand} ${Save_selected_option.carModel}</span>
            </div>
            <div class="detail-row">
                <span>Payment Method</span>
                <span>${paymentMethod}</span>
            </div>
            <hr style="margin-top: 40px">
        `);

        const order = JSON.parse(localStorage.getItem("pendingInsurance-" + localStorage.getItem("editOrderId")));

        document.getElementById('subTotal').textContent = `${order.receipt.subTotal}`;
        const editMode = localStorage.getItem('editMode') === 'true' || (localStorage.getItem('editMode') === 'check');
        const editOrderId = localStorage.getItem('editOrderId');

        if (editMode && editOrderId) {
            const pendingInsurance = JSON.parse(localStorage.getItem(`pendingInsurance-${editOrderId}`));
            document.getElementById('insuredDrivers').value = pendingInsurance.Save_selected_option_3.vehicle.insuredDrivers;
        }else {
            document.getElementById('insuredDrivers').value = Save_selected_option_2.insuredDrivers;
        }
        if(localStorage.getItem('editModeInsuredNum') != null){
            document.getElementById('insuredDrivers').value = localStorage.getItem('editModeInsuredNum');
            const driversContainer = $('#driversContainer');
            const s = JSON.parse(localStorage.getItem('Save_selected_option_3'));
            //alert(localStorage.getItem('editModeInsuredNum'));
            for(let i = parseInt(s.additionalDrivers.length) + 1; i < parseInt(localStorage.getItem('editModeInsuredNum')); i++){
                driversContainer.append(createDriverForm(i));
                //alert(i);
                const driverSection = document.getElementById(`driver-${i}`);
                if (driverSection) {
                    const fields = driverSection.querySelectorAll('input[required], select[required]');
                    fields.forEach(field => {
                        addValidationListeners(field);
                    });
                }
            }


        }
        document.getElementById('mainDrivingExperience').value = Save_selected_option_2.drivingExperience;
        document.getElementById('carModel').value = `${Save_selected_option.carBrand} ${Save_selected_option.carModel}`;
        document.getElementById('manufacturingYear').value = Save_selected_option.manufacturingYear;
        document.getElementById('marketValue').value = Save_selected_option.carValue;

    });
    let Save_selected_option_3 = {
        mainDriver: {},
        address: {},
        vehicle: {},
        additionalDrivers: []
    };

    function saveFormData() {
        Save_selected_option_3.mainDriver = {
            email: document.getElementById('email').value,
            mobile: document.getElementById('mobile').value,
            gender: document.querySelector('input[name="gender"]:checked').value,
            title: document.getElementById('title').value,
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            hkid: document.getElementById('hkid').value,
            dob: document.getElementById('dob').value,
            occupation: document.getElementById('occupation').value,
            drivingExperience: document.getElementById('mainDrivingExperience').value,
            ncd: document.getElementById('claimsDiscount').value,
            excess: document.getElementById('excess').value,
            driverOffencePoint: document.getElementById('offence_point').value,
            policyEndDate: calculateEndDate(Save_selected_option_2.policyEffectiveDate, Save_selected_option_2.paymentMethod)
        };

        Save_selected_option_3.address = {
            room: document.getElementById('room').value,
            floor: document.getElementById('floor').value,
            block: document.getElementById('block').value,
            building: document.getElementById('building').value,
            street: document.getElementById('street').value,
            area: document.getElementById('area').value,
            district: document.getElementById('district').value
        };

        Save_selected_option_3.vehicle = {
            carModel: document.getElementById('carModel').value,
            manufacturingYear: document.getElementById('manufacturingYear').value,
            marketValue: document.getElementById('marketValue').value,
            insuredDrivers: document.getElementById('insuredDrivers').value,
            claimsDiscount: document.getElementById('claimsDiscount').value,
            isRegistered: document.querySelector('input[name="registered"]:checked').value,
            registrationNumber: document.getElementById('registrationNumber').value,
            carModelCode: document.getElementById('carModelCode').value,
            cylinderCapacity: document.getElementById('cylinderCapacity').value,
            chassisNumber: document.getElementById('chassisNumber').value,
            engineNumber: document.getElementById('engineNumber').value
        };

        Save_selected_option_3.additionalDrivers = [];
        const numDrivers = parseInt(document.getElementById('insuredDrivers').value);

        for (let i = 1; i < numDrivers; i++) {
            const driverData = {
                title: document.getElementById(`driver-${i}-title`).value,
                firstName: document.getElementById(`driver-${i}-firstName`).value,
                lastName: document.getElementById(`driver-${i}-lastName`).value,
                hkid: document.getElementById(`driver-${i}-hkid`).value,
                dob: document.getElementById(`driver-${i}-dob`).value,
                occupation: document.getElementById(`driver-${i}-occupation`).value,
                drivingExperience: document.getElementById(`-${i}-DrivingExperience`).value,
                relation: document.getElementById(`driver-${i}-relation`).value
            };
            Save_selected_option_3.additionalDrivers.push(driverData);
        }

        localStorage.setItem('Save_selected_option_3', JSON.stringify(Save_selected_option_3));
        return Save_selected_option_3;
    }

    function closeTermsModal() {
        const modal = document.querySelector('.popup-overlay');
        if (modal) {
            modal.classList.remove('show');
            setTimeout(() => modal.remove(), 300);
        }
    }

    // Add styles for the modal
    const style = document.createElement('style');
    style.textContent = `
    .terms-content {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .terms-content ol {
        margin-top: 0.5rem;
    }

    .terms-content li {
        margin-bottom: 0.5rem;
    }

    #proceedButton:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
`;
    document.head.appendChild(style);

    function closePopupAndNavigate(url) {
        const popup = document.querySelector('.popup-overlay');
        popup.classList.remove('show');

        setTimeout(() => {
            window.location.href = url;
        }, 300);
    }


    document.addEventListener('DOMContentLoaded', function() {
        const editMode = localStorage.getItem('editMode') === 'true' || (localStorage.getItem('editMode') === 'check');
        const editOrderId = localStorage.getItem('editOrderId');

        if (editMode && editOrderId ) {
            const pendingInsurance = JSON.parse(localStorage.getItem(`pendingInsurance-${editOrderId}`));
            if (pendingInsurance) {
                // Set the form data from existing insurance
                //localStorage.setItem('Save_selected_option', JSON.stringify(pendingInsurance.Save_selected_option));
                //localStorage.setItem('Save_selected_option_2', JSON.stringify(pendingInsurance.Save_selected_option_2));
                //localStorage.setItem('Save_selected_option_3', JSON.stringify(pendingInsurance.Save_selected_option_3));

                // Update button text
                const buyButton = document.querySelector('.buy-button');
                if (buyButton) {
                    buyButton.textContent = 'Approve Application';
                }

                // First set the number of insured drivers
                if (pendingInsurance.Save_selected_option_3.vehicle && pendingInsurance.Save_selected_option_3.vehicle.insuredDrivers) {
                    document.getElementById('insuredDrivers').value = pendingInsurance.Save_selected_option_3.vehicle.insuredDrivers;
                }
                if(localStorage.getItem('editModeInsuredNum') != null){
                    document.getElementById('insuredDrivers').value = localStorage.getItem('editModeInsuredNum');
                }

                // Then create the driver forms
                const numDrivers = parseInt(document.getElementById('insuredDrivers').value);
                if (numDrivers > 1) {
                    const driversContainer = document.getElementById('driversContainer');
                    driversContainer.innerHTML = ''; // Clear existing forms

                    for (let i = 1; i < numDrivers; i++) {
                        driversContainer.innerHTML += createDriverForm(i);
                    }
                }

                // Finally populate all form fields including additional drivers
                populateFormFields(pendingInsurance.Save_selected_option_3);

                // Add validation listeners to all fields after they're created and populated
                const allFields = document.querySelectorAll('input, select');
                allFields.forEach(field => addValidationListeners(field));
            }
        }
        function populateFormFields(data) {
            if (!data) return;

            // Populate main driver details
            if (data.mainDriver) {
                document.getElementById('email').value = data.mainDriver.email || '';
                document.getElementById('mobile').value = data.mainDriver.mobile || '';
                document.getElementById('title').value = data.mainDriver.title || '';
                document.getElementById('firstName').value = data.mainDriver.firstName || '';
                document.getElementById('lastName').value = data.mainDriver.lastName || '';
                document.getElementById('hkid').value = data.mainDriver.hkid || '';
                document.getElementById('dob').value = data.mainDriver.dob || '';
                document.getElementById('claimsDiscount').value = data.mainDriver.ncd || '';
                document.getElementById('offence_point').value = data.mainDriver.driverOffencePoint || '';
                document.getElementById('occupation').value = data.mainDriver.occupation || '';
                document.getElementById('mainDrivingExperience').value = data.mainDriver.drivingExperience || '';

                // Set gender radio button
                const genderInput = document.querySelector(`input[name="gender"][value="${data.mainDriver.gender}"]`);
                if (genderInput) genderInput.checked = true;
            }

            // Populate address details
            if (data.address) {
                document.getElementById('room').value = data.address.room || '';
                document.getElementById('floor').value = data.address.floor || '';
                document.getElementById('block').value = data.address.block || '';
                document.getElementById('building').value = data.address.building || '';
                document.getElementById('street').value = data.address.street || '';
                document.getElementById('area').value = data.address.area || '';
                document.getElementById('excess').value = data.mainDriver.excess || '';
                document.getElementById('district').value = data.address.district || '';
            }

            // Populate vehicle details
            if (data.vehicle) {
                document.getElementById('carModel').value = data.vehicle.carModel || '';
                document.getElementById('manufacturingYear').value = data.vehicle.manufacturingYear || '';
                document.getElementById('marketValue').value = data.vehicle.marketValue || '';
                document.getElementById('registrationNumber').value = data.vehicle.registrationNumber || '';
                document.getElementById('carModelCode').value = data.vehicle.carModelCode || '';
                document.getElementById('cylinderCapacity').value = data.vehicle.cylinderCapacity || '';
                document.getElementById('chassisNumber').value = data.vehicle.chassisNumber || '';
                document.getElementById('engineNumber').value = data.vehicle.engineNumber || '';

                // Set registered radio button
                const registeredInput = document.querySelector(`input[name="registered"][value="${data.vehicle.isRegistered}"]`);
                if (registeredInput) registeredInput.checked = true;
            }

            // Handle additional drivers
            if (data.additionalDrivers && data.additionalDrivers.length > 0) {
                data.additionalDrivers.forEach((driver, index) => {
                    const driverNumber = index + 1;

                    // Ensure the elements exist before trying to set their values
                    const titleElement = document.getElementById(`driver-${driverNumber}-title`);
                    const firstNameElement = document.getElementById(`driver-${driverNumber}-firstName`);
                    const lastNameElement = document.getElementById(`driver-${driverNumber}-lastName`);
                    const hkidElement = document.getElementById(`driver-${driverNumber}-hkid`);
                    const dobElement = document.getElementById(`driver-${driverNumber}-dob`);
                    const occupationElement = document.getElementById(`driver-${driverNumber}-occupation`);
                    const drivingExpElement = document.getElementById(`-${driverNumber}-DrivingExperience`);
                    const relationElement = document.getElementById(`driver-${driverNumber}-relation`);

                    if (titleElement) titleElement.value = driver.title || '';
                    if (firstNameElement) firstNameElement.value = driver.firstName || '';
                    if (lastNameElement) lastNameElement.value = driver.lastName || '';
                    if (hkidElement) hkidElement.value = driver.hkid || '';
                    if (dobElement) dobElement.value = driver.dob || '';
                    if (occupationElement) occupationElement.value = driver.occupation || '';
                    if (drivingExpElement) drivingExpElement.value = driver.drivingExperience || '';
                    if (relationElement) relationElement.value = driver.relation || '';
                });
            }
        }

        function showThankYouPopup(referenceNumber, isEdit) {
            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.style.display = 'flex';
            localStorage.removeItem('editMode');
            localStorage.removeItem('editOrderId');
            if (isEdit) {
                popup.innerHTML = `
                <div class="popup-content">
                    <h2>Confirm Changes</h2>
                    <p>Are you sure you want to save these changes to your application?</p>
                    <div class="popup-buttons">
                        <button class="popup-button details-button" onclick="saveChangesAndRedirect('${referenceNumber}')">Save Changes</button>
                        <button class="popup-button end-button" onclick="closePopupAndNavigate('orderDetail.html?id=${referenceNumber}')">Cancel</button>
                    </div>
                </div>
            `;
            } else {
                popup.innerHTML = `
                <div class="popup-content">
                    <h2>Thank You For Your Quote!</h2>
                    <p>Our staff will review your application as soon as possible. We appreciate your trust in our services.</p>
                    <div class="popup-buttons">
                        <button class="popup-button details-button" onclick="closePopupAndNavigate('orderDetail.html?id=${referenceNumber}')">Check Details</button>
                        <button class="popup-button end-button" onclick="closePopupAndNavigate('index.html')">End</button>
                    </div>
                </div>
            `;
            }

            document.body.appendChild(popup);
            setTimeout(() => popup.classList.add('show'), 10);
        }


        document.querySelector('.buy-button').addEventListener('click', function(e) {

            e.preventDefault();

            if (!validateForm()) {
                const invalidFields = document.querySelectorAll('.invalid');
                if (invalidFields.length > 0) {
                    invalidFields[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    invalidFields[0].focus();
                    alert('Please fill in all required fields correctly.');
                }
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'popup-overlay';
            modal.style.display = 'flex';

            modal.innerHTML = `
            <div class="popup-content" style="max-width: 700px;">
                <p style="font-size: 35px"><strong>Policy Terms and Conditions</strong></p>
                <h3>Please read and accept our policy terms:</h3>
                <div class="terms-content" style="max-height: 300px; overflow-y: auto; margin: 1rem 0;">
                    <p>All information provided must be accurate and truthful.</p>
                        <p>Coverage begins only after payment is confirmed.</p>
                        <p>Claims process must be initiated within 24 hours of incident.</p>
                        <p>Policy is non-transferable without prior written consent.</p>
                        <p>Premium payments must be maintained as per selected schedule.</p>
                </div>
                <h3 style="color: red">You assign a ${document.getElementById('excess2').value}% discount to this policy</h3>
                <div class="popup-buttons">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="termsAccepted" required>
                        <span style="color: #b91c1c">I have read and agree to the policy terms and conditions</span>
                    </label>
                </div>
                <div class="popup-buttons">
                <button style="background-color: #6B7280" class="popup-button stay-button" onclick="closeTermsModal()">
                        Review Application
                    </button>
                    <button style="background-color: #00bcd4" class="popup-button save-button" id="proceedButton" disabled>
                        Approve Application
                    </button>

                </div>
            </div>
        `;

            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('show'), 10);

            // Add checkbox event listener
            const checkbox = modal.querySelector('#termsAccepted');
            const proceedButton = modal.querySelector('#proceedButton');

            checkbox.addEventListener('change', function() {
                proceedButton.disabled = !this.checked;
            });

            // Add proceed button event listener
            proceedButton.addEventListener('click', function() {
                const formData = saveFormData();
                const editMode = localStorage.getItem('editMode') === 'true' || (localStorage.getItem('editMode') === 'check');
                const referenceNumber = (editMode? editOrderId: generateReferenceNumber());


                const currentData = JSON.parse(localStorage.getItem(`pendingInsurance-${referenceNumber}`)) || {};
                currentData.discount = document.getElementById('excess2').value;
                currentData.raisePrice = document.getElementById('excess3').value;
                currentData.status = 'approved';
                currentData.Save_selected_option_2.checkoutPrice = document.getElementById('totalPrice').textContent;
                localStorage.setItem(`pendingInsurance-${referenceNumber}`, JSON.stringify(currentData));

                window.location.href = `orderDetail.html?id=${referenceNumber}`;

            });
        });
    });

    function showNcdInfo() {
        const modal = document.getElementById('ncdModal');
        modal.style.display = 'flex';
        modal.offsetHeight;
        modal.classList.add('show');
    }

    function closeNcdModal() {
        const modal = document.getElementById('ncdModal');
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300); // Match the transition duration
    }

    window.onclick = function(event) {
        const modal = document.getElementById('ncdModal');
        if (event.target === modal) {
            closeNcdModal();
        }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeNcdModal();
        }
    });

</script>
<style>
    .excess-input {
        position: relative;
    }

    .excess-input input {
        padding-right: 20px;
    }

    .excess-input::after {
        content: '%';
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
    }
    .upload-button {
        background-color: #00bcd4;
        color: white;
        border: none;
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 4px;
    }

    .upload-button:hover {
        background-color: #0097a7;
    }
</style>
<body>
<div class="navbar">
    <a href="www.google.com" style="display: flex; align-items: center; padding: 1rem;">
        <img src="../../../resources/image/icon-removebg.png" alt="Legend Motor Limited"
             style="position: absolute; margin-top: 0.75rem;height: 3rem; width: 3rem;">
        <span style="display: flex; margin-left: 0.75rem; align-items: center; align-self: center; padding-left: 2.5rem; font-size: 1.5rem; line-height: 2rem; font-weight: 600; white-space: nowrap;">LMC</span>
    </a>
    <div class="nav-links">
        <a class="navbar_a" href="index.html">Home</a>
        <a class="navbar_a" href="progress.html" style="color: orange">Apply</a>
        <a class="navbar_a" href="ordersIndex.html">Your Application</a>
        <a class="navbar_a" href="js/">About Us</a>
        <a class="navbar_a text-gray-700 hover:text-blue-500" href="../Sales/profile.html">Profile</a>
        <a class="navbar_a text-gray-700 hover:text-blue-500" href="../../../logout.html">Log Out</a>
    </div>
</div>

<div class="mainContainer" style="min-width: 1400px">
    <div style="display: flex; min-height: 100vh; padding: 2rem; gap: 2rem;">
        <div class="checkout_container">
            <div class="section">
                <div class="section-header">
                    <div class="header-left">
                        <img src="../../../resources/image/user-icon.svg" alt="User" class="section-icon">
                        <h1 id="editID"></h1>
                    </div>
                </div>

                <div id="applicantDetails" class="section-content">
                    <div class="notice">
                        <p style="font-size: large; color: darkred">* Please confirm all detail of this application, then approve. You only can review, <u>if need modify</u>, please contact the customer</p>
                    </div>
                    <button id="editDetail" style="display: none" onclick="location.href = 'estimate.html'" class="back-button">
                         Edit Details
                    </button>
                    <form id="applicantForm" class="form-section">
                        <h1>Main Driver Details</h1>
                        <div class="form-group">
                            <div class="input-group">
                                <label for="email">Email *</label>
                                <input type="email" id="email" disabled required>
                            </div>
                            <div class="input-group">
                                <label for="mobile">Mobile Number *</label>
                                <input type="tel" id="mobile" placeholder="A valid 8 digit phone number"
                                       pattern="[0-9]{8}" required>
                            </div>
                        </div>

                        <h2>Personal Details</h2>
                        <div class="form-group">
                            <div class="input-group">
                                <label>Gender *</label>
                                <div class="radio-group">
                                    <label class="radio-container">
                                        <input type="radio" name="gender" value="male" checked>
                                        <span class="radio-label">Male</span>
                                    </label>
                                    <label class="radio-container">
                                        <input type="radio" name="gender" value="female">
                                        <span class="radio-label">Female</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="input-group">
                                <label for="title">Title *</label>
                                <select id="title" required>
                                    <option value="MR">MR</option>
                                    <option value="MS">MS</option>
                                    <option value="MRS">MRS</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="firstName">First name *</label>
                                <input type="text" id="firstName" placeholder="(In English, e.g. Tai Man)" required>
                            </div>
                            <div class="input-group">
                                <label for="lastName">Last name *</label>
                                <input type="text" id="lastName" placeholder="(In English, e.g. Chan)" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="input-group">
                                <label for="hkid">HKID Card No. *</label>
                                <input type="text" id="hkid" placeholder="EG: A1234567" required>
                            </div>
                            <div class="input-group">
                                <label for="dob">Date of Birth *</label>
                                <input type="date" id="dob" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="input-group">
                                <label for="occupation">Occupation *</label>
                                <select id="occupation" required>
                                    <option value="">Select occupation</option>
                                    <option value="accountant">Account/ Accountant</option>
                                    <option value="engineer">Engineer</option>
                                    <option value="teacher">Teacher</option>
                                    <option value="doctor">Doctor</option>
                                    <option value="nurse">Nurse</option>
                                    <option value="lawyer">Lawyer</option>
                                    <option value="software_developer">Software Developer</option>
                                    <option value="designer">Designer</option>
                                    <option value="salesperson">Salesperson</option>
                                    <option value="manager">Manager</option>
                                    <option value="scientist">Scientist</option>
                                    <option value="marketing_specialist">Marketing Specialist</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="occupation">Occupation *</label>
                                <select id="mainDrivingExperience" required>
                                    <option value="more_than_5_years">More than 5 years</option>
                                    <option value="less_than_5_years">Less than 5 years</option>
                                    <option value="within_1_year">Started driving within 1 year</option>
                                </select>
                            </div>
                        </div>

                        <h2>Address</h2>
                        <div class="form-group">
                            <div class="input-group">
                                <label for="room">Room *</label>
                                <input type="text" id="room">
                            </div>
                            <div class="input-group">
                                <label for="floor">Floor *</label>
                                <input type="text" id="floor">
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="input-group">
                                <label for="block">Block *</label>
                                <input type="text" id="block">
                            </div>
                            <div class="input-group">
                                <label for="building">Building / Estate *</label>
                                <input type="text" id="building" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="input-group">
                                <label for="street">Street *</label>
                                <input type="text" id="street" required>
                            </div>
                            <div class="input-group">
                                <label for="area">Area *</label>
                                <select id="area" required>
                                    <option value="">Select area</option>
                                    <option value="hong-kong">Hong Kong</option>
                                    <option value="kowloon">Kowloon</option>
                                </select>
                            </div>
                        </div>
                        <div id="driversContainer"></div>
                        <div class="form-group">
                            <div class="input-group">
                                <label for="district">District *</label>
                                <select id="district" required>
                                    <option value="">Select district</option>
                                    <option value="aberdeen">Aberdeen</option>
                                    <option value="central">Central</option>
                                </select>
                            </div>

                        </div>
                        <h2>Insurance Detail</h2>
                        <div class="form-group">
                            <div class="input-group">
                                <label for="claimsDiscount">No Claims Discount *</label>
                                <select id="claimsDiscount" required>
                                    <option value="0%">0%</option>
                                    <option value="10%">No claims for 1 year (10%)</option>
                                    <option value="25%">No claims for 2 - 4 year (25%)</option>
                                    <option value="50%">No claims for 5 - 7 year (50%)</option>
                                    <option value="60%">No claims for 7 year or above (60%)</option>
                                </select>
                            </div>
                            <div class="input-group" style="width: 175px">
                                <label for="Excess">Excess *<button type="button" class="question-button" onclick="showNcdInfo()" aria-label="More information about No Claim Discount">?</button></label>
                                <span id="excessWarning" style="color: red; display: none;">Only accept 0% to 50%</span>
                                <div class="excess-input">
                                    <input type="number" id="excess" min="0" max="50" value="0" required>
                                </div>
                                <span id="excessWeight" style="color: red;"></span>
                            </div>
                            <div class="input-group">
                                <label for="offence_point">Driving-offence points *</label>
                                <input type="number" id="offence_point" min="0" max="15" value="0" required>
                                <div id="offence_point_warning" style="display: none"><br><br>
                                    <button type="button" id="uploadRecord" class="upload-button">Download Certificates of Traffic Conviction Records</button><br><span style="font-size: 20px; color: green"><em><b>Uploaded</b></em></span></div>
                            </div>
                        </div>
                    </form>
                    <div class="section-header">
                        <div class="header-left">
                            <img src="../../../resources/image/car-svg.svg" alt="Car" class="section-icon">
                            <h1>Insured Vehicle</h1>
                        </div>
                    </div>

                    <div id="vehicleDetails" class="section-content">
                        <form id="vehicleForm" class="form-section">
                            <h2>Vehicle Details</h2>
                            <div class="form-group">
                                <div class="input-group">
                                    <label for="carModel">Car Model *</label>
                                    <input type="text" id="carModel" value="BMW X4" required>
                                </div>
                                <div class="input-group">
                                    <label for="manufacturingYear">Manufacturing Year *</label>
                                    <input type="number" id="manufacturingYear" value="2024" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="input-group">
                                    <label for="marketValue">Estimated Car Market Value *</label>
                                    <input type="text" id="marketValue" placeholder="HK$" required>
                                </div>
                                <div class="input-group">
                                    <label for="insuredDrivers">Insured Drivers *</label>
                                    <input type="number" id="insuredDrivers" value="1" min="1" max="5" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="input-group">
                                    <label>Has the car already been registered? *</label>
                                    <div class="radio-group">
                                        <label class="radio-container">
                                            <input type="radio" name="registered" value="yes" checked>
                                            <span class="radio-label">Yes</span>
                                        </label>
                                        <label class="radio-container">
                                            <input type="radio" name="registered" value="no">
                                            <span class="radio-label">No</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div id="registrationDetails" class="registration-details">
                                <div class="form-group">
                                    <div class="input-group">
                                        <label for="registrationNumber">Registration Number *</label>
                                        <input type="text" id="registrationNumber" required>
                                    </div>
                                    <div class="input-group">
                                        <label for="carModelCode">Car Model *</label>
                                        <input type="text" id="carModelCode" placeholder="e.g. XDRIVE351A (E70)"
                                               required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="input-group">
                                        <label for="cylinderCapacity">Cylinder capacity (c.c) *</label>
                                        <input type="text" id="cylinderCapacity" required>
                                    </div>
                                    <div class="input-group">
                                        <label for="chassisNumber">Chassis Number *</label>
                                        <input type="text" id="chassisNumber" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="input-group">
                                        <label for="engineNumber">Engine Number *</label>
                                        <input type="text" id="engineNumber" required>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>


            <div class="order-summary">
                <div class="summary-header">Review Your Order</div>
                <div class="summary-content">
                    <div class="insurance-type">
                        <img src="../../../resources/image/seat-belt-svg.svg" alt="Car Insurance">
                        <div>
                            <h3></h3>
                        </div>
                    </div>

                    <div class="policy-details">
                        <div class="detail-row">
                            <span>Plan Name</span>
                            <span id="planName"></span>
                        </div>
                        <div class="detail-row">
                            <span>Policy effective date</span>
                            <span id="effectiveDate"></span>
                        </div>
                        <div class="detail-row">
                            <span>Policy end date</span>
                            <span id="endDate"></span>
                        </div>
                        <div class="detail-row">
                            <span>Maintenance Period</span>
                            <span></span>
                        </div>
                    </div>

                    <div class="price-breakdown">
                        <div class="detail-row">
                            <span>SUB-TOTAL</span>
                            <span id="subTotal"></span>
                        </div>
                        <div class="detail-row">
                            <span>+ Insurance Levy (0.04%)*</span>
                            <span id="insuranceLevy">-</span>
                        </div>
                        <div class="detail-row">
                            <span>+ MIB (0.25%)*</span>
                            <span id="mibCharge">-</span>
                        </div>

                        <div class="detail-row">
                            <span>+ Raise a price by staff</span>
                            <span id="raisePriceByStaff">-</span>
                        </div>

                        <div class="detail-row">
                            <span>+ Driving-offence points *</span>
                            <span id="markupOfPoint">-</span>
                        </div>

                        <div class="detail-row">
                            <span>- NCD*</span>
                            <span id="ncd"></span>
                        </div>

                        <div class="detail-row">
                            <span>- Discount by staff</span>
                            <span id="discountByStaff"></span>
                        </div>

                        <div class="detail-row">
                            <span>- Excess*</span>
                            <span id="detailExcess"></span>
                        </div>
                    </div>

                    <div class="total">
                        <span>Customer Total</span>
                        <span id="totalPrice" class="total-amount"></span>
                    </div>

                    <div class="payment-method-section">
                        <h3>Discount By Staff</h3>
                        <div class="payment-options">
                            <div class="input-group" style="width: 250px">
                                <label for="Excess">Excess *</label>
                                <div class="excess-input">
                                    <input type="number" id="excess2" min="0" max="50" value="0" required>
                                </div>
                                <div id="excessWeight2">
                                    <br>
                                    <span style="color: red;">With discount more than 5%, you need to describe the result</span>
                                    <input type="text" id="discountDescription" placeholder="Describe the result">
                                </div>
                            </div>
                        </div>

                        <h3>Raise a price By Staff</h3>
                        <div class="payment-options">
                            <div class="input-group" style="width: 250px">
                                <label for="Excess">Raise a price *</label>
                                <div>
                                    <input type="number" id="excess3" min="0" value="0" required>
                                </div>
                                <div id="excessWeight3">
                                    <br>
                                    <span style="color: red;">you need to describe the reason if raise a price</span>
                                    <input type="text" id="discountDescription3" value="DEMO" placeholder="Describe the result">
                                </div>
                            </div>
                        </div>
                    </div>


                    <button class="buy-button" id="buy-button">Request a quote</button>

                    <p class="payment-note">* Our staff will process your order as soon as possible.
                    </p>
                    <p>Estimated processing time: <strong><u>1-2 business days</u></strong></p>
                </div>
            </div>
        </div>
    </div>

</div>

<div id="ncdModal" class="ncd-modal">
    <div class="ncd-modal-content">
        <span class="ncd-close" onclick="closeNcdModal()">&times;</span>
        <h2>Car Insurance Excess</h2>
        <p>Car insurance excess is the amount you pay out-of-pocket when making a claim. It helps keep your premiums lower by reducing minor claims.</p>

        <h3>Types of Excess:</h3>
        <ul>
            <li><strong>Compulsory Excess:</strong> A fixed amount set by your insurer that you must pay for each claim.</li>
            <li><strong>Voluntary Excess:</strong> An extra amount you choose to pay to lower your premium.</li>
            <li><strong>Age Excess:</strong> Applies if the driver is under 25 years old.</li>
            <li><strong>Inexperienced Driver Excess:</strong> For drivers over 25 who have held their license for less than two years.</li>
        </ul>

        <h3>How It Works:</h3>
        <p>If your car repair costs $3,000 and your total excess is $500, you pay $500, and the insurer pays $2,500.</p>

        <h3>Why Have an Excess?</h3>
        <p>An excess helps keep insurance costs down by encouraging only significant claims.</p>

        <h3>Key Points:</h3>
        <ul>
            <li>Choose an excess amount you can afford to pay in case of an accident.</li>
            <li>You will pay the excess for various claims, like accidents or theft.</li>
        </ul>
    </div>
</div>
</body>

<footer>
    <p>&copy; 2024 Legend Motor Limited. All rights reserved.</p>
</footer>
</html>