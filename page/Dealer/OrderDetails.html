<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <title>Order Details | Legend Motor Limited</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta content="ie=edge" http-equiv="X-UA-Compatible"/>
    <meta content="Dashboard" name="description"/>
    <meta content="dashboard, page" name="keywords"/>
    <meta content="noindex, nofollow" name="robots"/>
    <link
            href="../../resources/image/LMC_login.png"
            rel="icon"
            type="image/x-icon"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp,container-queries"></script>
    <script type="module" src="../../resources/js/script.js"></script>
    <script type="module" src="../../resources/js/module/cartApi.js"></script>
    <script type="module" src="../../resources/js/ViewCart.js"></script>
    <!--    <script src="../../resources/js/OrderDetails.js"></script>-->
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: "#eff6ff",
                            100: "#dbeafe",
                            200: "#bfdbfe",
                            300: "#93c5fd",
                            400: "#60a5fa",
                            500: "#3b82f6",
                            600: "#2563eb",
                            700: "#1d4ed8",
                            800: "#1e40af",
                            900: "#1e3a8a",
                            950: "#172554",
                        },
                    },
                },
                fontFamily: {
                    body: [
                        "Inter",
                        "ui-sans-serif",
                        "system-ui",
                        "-apple-system",
                        "system-ui",
                        "Segoe UI",
                        "Roboto",
                        "Helvetica Neue",
                        "Arial",
                        "Noto Sans",
                        "sans-serif",
                        "Apple Color Emoji",
                        "Segoe UI Emoji",
                        "Segoe UI Symbol",
                        "Noto Color Emoji",
                    ],
                    sans: [
                        "Inter",
                        "ui-sans-serif",
                        "system-ui",
                        "-apple-system",
                        "system-ui",
                        "Segoe UI",
                        "Roboto",
                        "Helvetica Neue",
                        "Arial",
                        "Noto Sans",
                        "sans-serif",
                        "Apple Color Emoji",
                        "Segoe UI Emoji",
                        "Segoe UI Symbol",
                        "Noto Color Emoji",
                    ],
                },
            },
        };
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white">
<div class="flex h-screen">
    <!-- Navigation -->
    <nav class="bg-white border-gray-200 dark:bg-gray-900 w-64 flex-shrink-0 hidden md:flex md:flex-col">
        <div class="flex flex-col items-center p-4">
            <a class="flex items-center space-x-3 rtl:space-x-reverse mb-6" href="#">
                <div class="h-8 w-8 relative">
                    <img alt="SLMC Logo" class="absolute inset-0 object-contain dark:hidden pt-2 dark:pt-1"
                         src="../../resources/image/SLMC_LOGO.png"/>
                    <img alt="SLMC Logo" class="absolute inset-0 object-contain hidden dark:block"
                         src="../../resources/image/SLMC_LOGO_DM.png"/>
                </div>
                <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">SLMC</span>
            </a>

            <ul class="font-medium flex flex-col space-y-2">
                <li>
                    <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                       href="viewOrderRecord.html">Order Record</a>
                </li>
                <li>
                    <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                       href="viewSparePart.php">Spare Part</a>
                </li>
                <li>
                    <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                       href="shoppingCart.php">Cart</a>
                </li>
                <li>
                    <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                       href="profile.html">Profile</a>
                </li>
                <li>
                    <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                       href="../../logout.html" onclick="logout()">Log Out</a>
                </li>
            </ul>

            <!-- Dark mode toggle button -->
            <button class="mt-6 p-2 text-gray-500 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-700"
                    id="darkModeToggle">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z">
                    </path>
                </svg>
            </button>
        </div>
    </nav>

    <!-- Mobile Menu Button -->
    <div class="md:hidden flex items-center justify-between p-4 bg-white dark:bg-gray-900">
        <a href="#" class="flex items-center space-x-3 rtl:space-x-reverse">
            <div class="h-8 w-8 relative">
                <img alt="SLMC Logo" class="absolute inset-0 object-contain dark:hidden pt-2 dark:pt-1"
                     src="../../resources/image/SLMC_LOGO.png"/>
                <img alt="SLMC Logo" class="absolute inset-0 object-contain hidden dark:block"
                     src="../../resources/image/SLMC_LOGO_DM.png"/>
            </div>
            <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">SLMC</span>
        </a>
        <button class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-700"
                id="mobileMenuButton">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
    </div>

    <!-- Mobile Menu -->
    <div class="md:hidden flex flex-col" id="mobileMenu" style="display: none;">
        <ul class="font-medium flex flex-col space-y-2 p-4 bg-white dark:bg-gray-900">
            <li>
                <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                   href="viewOrderRecord.html">Order Record</a>
            </li>
            <li>
                <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                   href="viewSparePart.php">Spare Part</a>
            </li>
            <li>
                <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                   href="shoppingCart.php">Cart</a>
            </li>
            <li>
                <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                   href="profile.html">Profile</a>
            </li>
            <li>
                <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                   href="../../logout.html" onclick="logout()">Log Out</a>
            </li>
        </ul>
    </div>
    <!--------------------Order-------------------->
    <body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-white">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-6" id="OrderDetails-title">Order Details - SL00008</h1>

        <div class="flex flex-col md:flex-row gap-6">
            <!-- Order Summary -->
            <div class="md:w-1/2">
                <div class="hidden justify-center items-center my-4" id="loadingSpinner">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
                </div>
                <div
                        class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg p-6"
                        id="orderSummaryDiv"
                >
                    <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
                    <div class="grid grid-cols-2 gap-4" id="orderSummary">
                        <!-- it will be rendered by javascript -->
                    </div>
                </div>
            </div>

            <!-- Order Items -->
            <div class="md:w-1/2" id="orderItemsDiv">
                <div
                        class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg"
                >
                    <table
                            class="min-w-full divide-y divide-gray-200 dark:divide-gray-700"
                    >
                        <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
                                    scope="col"
                            >
                                Item
                            </th>
                            <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
                                    scope="col"
                            >
                                Quantity
                            </th>
                            <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
                                    scope="col"
                            >
                                Price
                            </th>
                            <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
                                    scope="col"
                            >
                                Total
                            </th>
                        </tr>
                        </thead>
                        <tbody
                                class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700"
                                id="order-Details-Product"
                        >
                        <!-- Product will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Order Actions -->
        <div
                class="mt-8 flex flex-col sm:flex-row justify-between items-center gap-4"
                id="orderActions"
        >
            <a
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded inline-flex items-center"
                    href="viewOrderRecord.html"
            >
                <svg
                        class="fill-current w-4 h-4 mr-2"
                        viewBox="0 0 20 20"
                        xmlns="http://www.w3.org/2000/svg"
                >
                    <path
                            d="M10 8.586L2.929 1.515 1.515 2.929 8.586 10l-7.071 7.071 1.414 1.414L10 11.414l7.071 7.071 1.414-1.414L11.414 10l7.071-7.071-1.414-1.414L10 8.586z"
                    />
                </svg>
                <span>Return to Order Records</span>
            </a>
            <div class="flex flex-wrap justify-center sm:justify-end gap-2 hidden" id="orderActionsDiv">
                <button
                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
                        id="printOrder"
                >
                    Print Order
                </button>
                <button
                        class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
                        id="downloadInvoice"
                >
                    Download Invoice
                </button>
                <button
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded"
                        id="deleteOrder"
                >
                    Delete Order
                </button>
            </div>
        </div>

        <script>
            function printOrder() {
                const orderID = getURLParameter('id');
                const apiUrl = `../../resources/php/order_api.php?action=print&id=${orderID}`;
                const AuthToken = localStorage.getItem('userToken');

                return fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + AuthToken
                    },
                    credentials: 'include'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.click();
                        window.URL.revokeObjectURL(url);
                    })
                    .catch(error => {
                        console.error('Error printing order:', error);


                        displayError(error.message);
                    });
            }

            function displayError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.id = 'errorDiv';
                errorDiv.className = 'text-red-500 text-center mt-4';
                errorDiv.textContent = message;
                document.getElementById('orderSummaryDiv').insertAdjacentElement('beforebegin', errorDiv);
            }

            function DownloadInvoice() {
                const orderID = getURLParameter('id');
                const dealerID = sessionStorage.getItem('username') || localStorage.getItem('username') || getCookie('id');
                const apiUrl = `../../resources/php/order_api.php?action=download&id=${orderID}&username=${dealerID}`;
                const AuthToken = localStorage.getItem('userToken');

                return fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + AuthToken
                    },
                    credentials: 'include'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${orderID}.pdf`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                    })
                    .catch(error => {
                        console.error('Error downloading invoice:', error);
                        displayError(error.message);
                    });
            }

            document.addEventListener('DOMContentLoaded', function () {
                // if (getURLParameter('id') == null || localStorage.getItem('userToken') == null) {
                //     window.location.href = "../../error/403.html";
                // }

                showLoading();
                fetchOrderData()
                    .then(orderData => {
                        console.log(orderData);
                        renderOrderSummary(orderData.summary);
                        renderOrderItems(orderData.items);
                        renderOrderActions(orderData.summary);
                        setupEventListeners();
                    })
                    .catch(error => {
                        console.error('Error fetching order data:', error);
                        displayError(error.message);
                    })
                    .finally(() => {
                        hideLoading();
                    });
            });

            function getURLParameter(name) {
                return new URLSearchParams(window.location.search).get(name);
            }

            function fetchOrderData() {
                const orderID = getURLParameter('id');
                const apiUrl = `../../resources/php/order_api.php?action=Dealer-get&id=${orderID}`;
                const AuthToken = localStorage.getItem('userToken');

                return fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AuthToken}`
                    },
                    credentials: 'include'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success' && data.data) {
                            return data.data;
                        } else {
                            throw new Error(data.message || 'Failed to fetch order details');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching order data:', error);
                        // window.location.href = "./viewOrderRecord.html"
                        throw error; // Re-throw the error for further handling if needed
                    });
            }

            function formatDate(dateString) {
                // DD/MM/YYYY format
                if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) {
                    const [day, month, year] = dateString.split('/');
                    return `${day}/${month}/${year}`;
                }
                // YYYY-MM-DD format
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                    const [year, month, day] = dateString.split('-');
                    return `${day}/${month}/${year}`;
                }
                console.error('Invalid date string:', dateString);
                return 'Invalid Date';
            }

            function formatTime(timeString) {
                if (!timeString || !/^\d{2}:\d{2}(:\d{2})?$/.test(timeString)) {
                    console.error('Invalid time string:', timeString);
                    return 'Invalid Time';
                }
                const [hours, minutes] = timeString.split(':');
                return `${hours}:${minutes}`;
            }

            function renderOrderSummary(order) {
                const summaryContainer = document.getElementById('orderSummary');
                summaryContainer.innerHTML = `
        <p><strong>Order Date:</strong> ${formatDate(order.orderDate)}</p>
        <p><strong>Order Time:</strong> ${order.orderTime}</p>
        <p><strong>Order Status:</strong> ${order.orderStatus}</p>
        <p><strong>Sales Manager ID:</strong> ${order.salesManagerId}</p>
        <p><strong>Sales Manager:</strong> ${order.salesManager}</p>
        <p><strong>Contact:</strong> ${order.salesManagerContact}</p>
        <p><strong>Delivery Address:</strong> ${order.deliveryAddress}</p>
        <p><strong>Delivery Date:</strong> ${formatDate(order.deliveryDate)}</p>
        <p><strong>Contact Person:</strong> ${order.contactPerson}</p>
        <p><strong>Contact Phone:</strong> ${order.contactPhone}</p>
        <p><strong>Total Amount:</strong> $${order.totalAmount.toLocaleString()}</p>
        <p><strong>Total Weight:</strong> ${order.totalWeight}kg</p>
        <p><strong>Shipping Cost:</strong> $${order.shippingCost} ($${(order.shippingCost / order.totalWeight).toFixed(2)}/kg)</p>
        <p><strong>Total Cost:</strong> $${order.totalCost.toLocaleString()}</p>
    `;
                document.getElementById('OrderDetails-title').textContent = `Order Details - ${order.id}`;
            }

            function renderOrderItems(items) {
                const itemsContainer = document.getElementById('order-Details-Product');
                itemsContainer.innerHTML = items.map(item => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap">${item.name} (${item.id})</td>
            <td class="px-6 py-4 whitespace-nowrap">${item.quantity}</td>
            <td class="px-6 py-4 whitespace-nowrap">$${item.price.toLocaleString()}</td>
            <td class="px-6 py-4 whitespace-nowrap">$${(item.quantity * item.price).toLocaleString()}</td>
        </tr>
    `).join('');
            }

            function renderOrderActions(order) {
                const actionButtons = getActionButtons();

                switch (order.orderStatus) {
                    case 'Wait for confirmation':
                        setActionVisibility(actionButtons, false, false, false);
                        break;
                    case 'Shipping':
                        setActionVisibility(actionButtons, true, false, false);
                        break;
                    case 'Preparing':
                        setActionVisibility(actionButtons, true, true, true);
                        break;
                    case 'Shipped':
                        setActionVisibility(actionButtons, true, true, false);
                        break;
                    case 'Cancelled':
                    default:
                        setActionVisibility(actionButtons, false, false, false);
                        break;
                }
            }

            function setActionVisibility(actions, print, download, del) {
                actions.print.style.display = print ? 'block' : 'none';
                actions.download.style.display = download ? 'block' : 'none';
                actions.delete.style.display = del ? 'block' : 'none';
            }

            function initializeOrderActionButtons() {
                const actionButtons = getActionButtons();

                actionButtons.print.addEventListener('click', printOrder);
                actionButtons.download.addEventListener('click', downloadInvoice);
                actionButtons.delete.addEventListener('click', deleteOrder);
            }

            function getActionButtons() {
                return {
                    print: document.getElementById('printOrder'),
                    download: document.getElementById('downloadInvoice'),
                    delete: document.getElementById('deleteOrder')
                };
            }

            document.getElementById('deleteOrder').addEventListener('click', deleteOrder);

            function deleteOrder() {
                if (confirm('Are you sure you want to delete this order?')) {
                    DeleteOrder();
                }
            }

            function DeleteOrder() {
                const orderID = getURLParameter('id');
                const apiUrl = `../../resources/php/order_api.php?action=delete&id=${orderID}`;
                const AuthToken = localStorage.getItem('userToken');

                fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + AuthToken
                    },
                    credentials: 'include'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Order deleted successfully');
                            window.location.href = "./viewOrderRecord.html";
                        } else {
                            alert('Failed to delete order: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting order:', error);
                        alert('Error deleting order: ' + error.message);
                    });
            }

            function setupEventListeners() {
                document.getElementById('mobileMenuButton').addEventListener('click', toggleMobileMenu);
                document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
                initializeOrderActionButtons();
            }

            function toggleMobileMenu() {
                const mobileMenu = document.getElementById('mobileMenu');
                mobileMenu.style.display = mobileMenu.style.display === 'none' ? 'flex' : 'none';
            }

            function toggleDarkMode() {
                document.documentElement.classList.toggle('dark');
            }

            function showLoading() {
                document.getElementById('loadingSpinner').classList.remove('hidden');
                document.getElementById('orderSummaryDiv').classList.add('hidden');
                document.getElementById('orderActionsDiv').classList.add('hidden');
                document.getElementById('orderItemsDiv').classList.add('hidden');
                document.getElementById('OrderDetails-title').textContent = 'Order Details - Loading...';
            }

            function hideLoading() {
                document.getElementById('loadingSpinner').classList.add('hidden');
                document.getElementById('orderSummaryDiv').classList.remove('hidden');
                document.getElementById('orderActionsDiv').classList.remove('hidden');
                document.getElementById('orderItemsDiv').classList.remove('hidden');
            }
        </script>
    </div>
    </body>
</body>
</html>



