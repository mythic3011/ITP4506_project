<!DOCTYPE html>
<html lang="en">
  <head class="dark" lang="en">
    <title>Order | Username | Legend Motor Limited</title>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <link href="../../resources/css/order.css" rel="stylesheet" />
    <link
      href="../../resources/image/icon_dark.png"
      rel="icon"
      type="image/x-icon"
    />
    <script type="module" src="../../resources/js/script.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp,container-queries"></script>
    <script type="module" src="../../resources/js/ManageOrder.js"></script>
  </head>
  <!--------------------Menu-------------------->
  <div class="flex h-screen">
    <!-- Navigation -->
    <nav
      class="bg-white border-gray-200 dark:bg-gray-900 w-64 flex-shrink-0 hidden md:flex md:flex-col"
    >
      <div class="flex flex-col items-center p-4">
        <a
          class="flex items-center space-x-3 rtl:space-x-reverse mb-6"
          href="#"
        >
          <div class="h-8 w-8 relative">
            <img
              alt="LMC Logo"
              class="absolute inset-0 object-contain dark:hidden pt-2 dark:pt-1"
              src="../../resources/image/LMC.png"
            />
            <img
              alt="LMC Logo"
              class="absolute inset-0 object-contain hidden dark:block"
              src="../../resources/image/LMC_DM.png"
            />
          </div>
          <span
            class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white"
            >LMC</span
          >
        </a>

        <ul class="font-medium flex flex-col space-y-2">
          <li>
            <a
              class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
              href="order.html"
              >Order Record</a
            >
          </li>
          <li>
            <a
              class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
              href="Item.html"
              >Vehicle</a
            >
          </li>
          <li>
            <a
              class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
              href="genreport.html"
              >Generate Report</a
            >
          </li>
          <li>
            <a
              class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
              href="../../logout.html"
              onclick="logout()"
              >Log Out</a
            >
          </li>
        </ul>

        <!-- Dark mode toggle button -->
        <button
          class="mt-6 p-2 text-gray-500 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-700"
          id="darkModeToggle"
        >
          <svg
            class="w-5 h-5"
            fill="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
            ></path>
          </svg>
        </button>
      </div>
    </nav>

    <!-- Mobile Menu Button -->
    <div
      class="md:hidden flex items-center justify-between p-4 bg-white dark:bg-gray-900"
    >
      <a href="#" class="flex items-center space-x-3 rtl:space-x-reverse">
        <div class="h-8 w-8 relative">
          <img
            alt="LMC Logo"
            class="absolute inset-0 object-contain dark:hidden pt-2 dark:pt-1"
            src="../../resources/image/LMC.png"
          />
          <img
            alt="LMC Logo"
            class="absolute inset-0 object-contain hidden dark:block"
            src="../../resources/image/LMC_DM.png"
          />
        </div>
        <span
          class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white"
          >LMC</span
        >
      </a>
      <button
        class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-700"
        id="mobileMenuButton"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h16"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Mobile Menu -->
    <!--------------------Menu-------------------->
    <body
      class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-body"
    >
      <div class="md:hidden" id="mobileMenu" style="display: none">
        <ul
          class="font-medium flex flex-col space-y-2 p-4 bg-white dark:bg-gray-900"
        >
          <li>
            <a
              class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
              href="order.html"
              >Order Record</a
            >
          </li>
          <li>
            <a
              class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
              href="Item.html"
              >Vehicle</a
            >
          </li>
          <li>
            <a
              class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
              href="genreport.html"
              >Generate Report</a
            >
          </li>
          <li>
            <a
              class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
              href="../../logout.html"
              onclick="logout()"
              >Log Out</a
            >
          </li>
        </ul>
      </div>
      <main class="mainContainer mx-auto px-4 py-8">
        <section class="prose dark:prose-invert max-w-none" id="orderSection">
          <h1 class="text-3xl font-bold mb-4">Current Orders</h1>
          <h2 class="text-xl mb-4" id="Total-Orders-number">Total: 7 orders</h2>

          <div class="mb-4">
            <a
              class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded"
              href="genreport.html"
            >
              Generate report
            </a>
          </div>

          <div class="overflow-x-auto shadow-md sm:rounded-lg">
            <p
              class="text-sm text-gray-600 dark:text-gray-400"
              id="sortingInfo"
            >
              Click the column header to sort.
            </p>
            <table
              class="w-full text-sm text-left text-gray-500 dark:text-gray-400"
              id="orderTable"
            >
              <thead
                class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"
              >
                <tr>
                  <th
                    class="px-6 py-3 cursor-pointer"
                    onclick="sortTable(0)"
                    scope="col"
                  >
                    Order ID
                  </th>
                  <th
                    class="px-6 py-3 cursor-pointer"
                    onclick="sortTable(1)"
                    scope="col"
                  >
                    Sales Manager ID
                  </th>
                  <th
                    class="px-6 py-3 cursor-pointer"
                    onclick="sortTable(2)"
                    scope="col"
                  >
                    Order Date & Time
                  </th>
                  <th
                    class="px-6 py-3 cursor-pointer"
                    onclick="sortTable(3)"
                    scope="col"
                  >
                    Delivery Date
                  </th>
                  <th
                    class="px-6 py-3 cursor-pointer"
                    onclick="sortTable(4)"
                    scope="col"
                  >
                    status
                  </th>
                  <th
                    class="px-6 py-3 cursor-pointer"
                    onclick="sortTable(8)"
                    scope="col"
                  >
                    Shipping Cost
                  </th>
                  <th
                    class="px-6 py-3 cursor-pointer"
                    onclick="sortTable(9)"
                    scope="col"
                  >
                    Total Order Amount
                  </th>
                  <th class="px-6 py-3" scope="col">Update state</th>
                </tr>
              </thead>
              <tbody id="orderTableBody">
                <!-- Table rows will be inserted here by JavaScript -->
              </tbody>
            </table>
          </div>
        </section>
        <footer class="text-center py-4 mt-6">
          <p class="text-gray-700 dark:text-gray-300">
            Â© 2024 Legend Motor Limited. All rights reserved.
          </p>
        </footer>
      </main>
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          getOrderFromServer();
        });

        function getOrderFromServer() {
          const apiUrl = `../../resources/php/order_api.php?action=Sales-manager-list`;
          const AuthToken = localStorage.getItem("userToken");

          fetch(apiUrl, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + AuthToken,
            },
            credentials: "include",
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.status === "success" && data.data) {
                loadRecord(data.data);
              } else {
                throw new Error(
                  data.message || "Failed to fetch order details"
                );
              }
            })
            .catch((error) => {
              console.error("Error fetching order data:", error);
              // Display error message to user
              document.getElementById(
                "orderTableBody"
              ).innerHTML = `<tr><td colspan="11" class="text-center text-red-500">Error loading orders: ${error.message}</td></tr>`;
            });
        }

        function loadRecord(orders) {
          document.title = `Order | ${
            localStorage.getItem("username") || "Username"
          } | Legend Motor Limited`;

          const tableBody = document.getElementById("orderTableBody");
          tableBody.replaceChildren(); // Clear existing content first

          orders.forEach((order) => {
            const row = document.createElement("tr");
            row.className =
              "bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600";

            const cellData = [
              {
                value: order.orderID,
                class: "font-medium text-gray-900 dark:text-white",
              },
              {
                value: order.salesManagerID,
                class: "text-gray-500 dark:text-gray-400 font-medium",
              },
              {
                value: order.orderDateTime,
                class: "text-gray-500 dark:text-gray-400",
              },
              {
                value: order.deliveryDate,
                class: "text-gray-500 dark:text-gray-400",
              },
              {
                value: order.orderStatus,
                class: `text-gray-900 dark:text-white font-semibold rounded-full inline-flex text-xxs leading-1 pt-4 px-2 py-4 pb-2 pr-2 pl-2 ${getStatusClass(
                  order.orderStatus
                )}`,
              },
              {
                value: order.shipCost,
                class: "text-gray-500 dark:text-gray-400",
              },
              {
                value: order.totalCost,
                class: "text-gray-900 dark:text-white font-bold",
              },
            ];

            cellData.forEach((data) => {
              const cell = document.createElement("td");
              cell.className = `px-6 py-4 ${data.class}`;
              cell.textContent = Array.isArray(data.value)
                ? data.value.join(", ")
                : data.value;
              row.appendChild(cell);
            });

            const updateCell = document.createElement("td");
            updateCell.className = "px-6 py-4";
            const updateLink = document.createElement("a");
            updateLink.href = `orderinfo.html?OrderId=${order.orderID}`;
            updateLink.className =
              "font-medium text-blue-600 dark:text-blue-500 hover:underline";
            updateLink.textContent = "Update";
            updateCell.appendChild(updateLink);
            row.appendChild(updateCell);

            tableBody.appendChild(row);
          });

          document.getElementById(
            "Total-Orders-number"
          ).textContent = `Total: ${orders.length} orders`;
        }

        function getStatusClass(status) {
          switch (status.toLowerCase()) {
            case "wait for confirmation":
              return "bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100";
            case "shipped":
              return "bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100";
            case "processing":
              return "bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100";
            case "shipping":
              return "bg-purple-100 text-purple-800 dark:bg-purple-800 dark:text-purple-100";
            case "cancelled":
              return "bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100";
            default:
              return "bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-100";
          }
        }

        function sortTable(columnIndex) {
          const table = document.getElementById("orderTable");
          const tbody = table.querySelector("tbody");
          const rows = Array.from(tbody.querySelectorAll("tr"));
          const isAscending = table.getAttribute("data-order") === "asc";

          rows.sort((a, b) => {
            const aValue = a.cells[columnIndex].textContent.trim();
            const bValue = b.cells[columnIndex].textContent.trim();
            return isAscending
              ? aValue.localeCompare(bValue)
              : bValue.localeCompare(aValue);
          });

          tbody.replaceChildren(); // Clear existing rows
          rows.forEach((row) => tbody.appendChild(row));

          table.setAttribute("data-order", isAscending ? "desc" : "asc");
        }
      </script>
    </body>
  </div>
</html>
