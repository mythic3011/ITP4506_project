<!doctype html>
<html lang="en">
<head class="dark" lang="en">
    <meta charset="UTF-8">
    <title>Order info | Username | Legend Motor Limited</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="ie=edge" http-equiv="X-UA-Compatible">
    <meta content="Dashboard" name="description">
    <meta content="dashboard, page" name="keywords">
    <meta content="noindex, nofollow" name="robots">
    <link href="../../resources/image/icon_dark" rel="icon" type="image/x-icon"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp,container-queries"></script>
    <script type="module" src="../../resources/js/script.js"></script>
    <script type="module" src="../../resources/js/module/auth.js"></script>
    <script type="module" src="../../resources/js/module/api.js"></script>
    <script type="module" src="../../resources/js/OrderAction.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            "50": "#eff6ff",
                            "100": "#dbeafe",
                            "200": "#bfdbfe",
                            "300": "#93c5fd",
                            "400": "#60a5fa",
                            "500": "#3b82f6",
                            "600": "#2563eb",
                            "700": "#1d4ed8",
                            "800": "#1e40af",
                            "900": "#1e3a8a",
                            "950": "#172554"
                        }
                    }
                },
                fontFamily: {
                    'body': [
                        'Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'system-ui', 'Segoe UI', 'Roboto',
                        'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif', 'Apple Color Emoji', 'Segoe UI Emoji',
                        'Segoe UI Symbol', 'Noto Color Emoji'
                    ],
                    'sans': [
                        'Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'system-ui', 'Segoe UI', 'Roboto',
                        'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif', 'Apple Color Emoji', 'Segoe UI Emoji',
                        'Segoe UI Symbol', 'Noto Color Emoji'
                    ]
                }
            }
        }

        function displayError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.id = 'errorDiv';
            errorDiv.style = "margin-top: 1rem; text-align: center; color: #EF4444; ";
            errorDiv.textContent = message;
            document.getElementById('orderSummaryDiv').insertAdjacentElement('beforebegin', errorDiv);
        }

        function printOrder(div) {
            var printContents = document.getElementById(div).innerHTML;
            var originalContents = document.body.innerHTML;
            document.body.innerHTML = printContents;
            window.print();
            document.body.innerHTML = originalContents;
        }

        document.addEventListener('DOMContentLoaded', function () {
            // if (getURLParameter('id') == null || localStorage.getItem('userToken') == null) {
            //     window.location.href = "../../error/403.html";
            // }

            showLoading();
            fetchOrderData()
                .then(orderData => {
                    console.log(orderData);
                    renderOrderSummary(orderData.summary);
                    renderOrderItems(orderData.items);
                    renderOrderActions(orderData.summary);
                    setupEventListeners();
                })
                .catch(error => {
                    console.error('Error fetching order data:', error);
                    displayError(error.message);
                })
                .finally(() => {
                    hideLoading();
                });
        });

        function getURLParameter(name) {
            return new URLSearchParams(window.location.search).get(name);
        }

        function fetchOrderData() {
            const orderID = getURLParameter('OrderId');
            const apiUrl = `../../resources/php/order_api.php?action=Sales-Manager-get&id=${orderID}`;
            const AuthToken = localStorage.getItem('userToken');

            return fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${AuthToken}`
                },
                credentials: 'include'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success' && data.data) {
                        return data.data;
                    } else {
                        throw new Error(data.message || 'Failed to fetch order details');
                    }
                })
                .catch(error => {
                    console.error('Error fetching order data:', error);
                    // window.location.href = "./viewOrderRecord.html"
                    throw error; // Re-throw the error for further handling if needed
                });
        }

        function formatDate(dateString) {
            // DD/MM/YYYY format
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) {
                const [day, month, year] = dateString.split('/');
                return `${day}/${month}/${year}`;
            }
            // YYYY-MM-DD format
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                const [year, month, day] = dateString.split('-');
                return `${day}/${month}/${year}`;
            }
            console.error('Invalid date string:', dateString);
            return 'Invalid Date';
        }

        function formatTime(timeString) {
            if (!timeString || !/^\d{2}:\d{2}(:\d{2})?$/.test(timeString)) {
                console.error('Invalid time string:', timeString);
                return 'Invalid Time';
            }
            const [hours, minutes] = timeString.split(':');
            return `${hours}:${minutes}`;
        }

        function renderOrderSummary(order) {
            document.title = `Order Details - ${order.id} | ${localStorage.getItem('username')} | Legend Motor Limited`;
            const summaryContainer = document.getElementById('orderSummary');
            summaryContainer.innerHTML = `
            <p><strong>Order Date:</strong> ${formatDate(order.orderDate)}</p>
            <p><strong>Order Time:</strong> ${order.orderTime}</p>
        <p><strong>Order Status:</strong> ${order.orderStatus}</p>
        <p><strong>Sales Manager ID:</strong> ${order.salesManagerId}</p>
        <p><strong>Sales Manager:</strong> ${order.salesManager}</p>
        <p><strong>Contact:</strong> ${order.salesManagerContact}</p>
        <p><strong>Delivery Address:</strong> ${order.deliveryAddress}</p>
        <p><strong>Delivery Date:</strong> ${formatDate(order.deliveryDate)}</p>
        <p><strong>Contact Person:</strong> ${order.contactPerson}</p>
        <p><strong>Contact Phone:</strong> ${order.contactPhone}</p>
        <p><strong>Total Amount:</strong> $${order.totalAmount.toLocaleString()}</p>
        <p><strong>Total Weight:</strong> ${order.totalWeight}kg</p>
        <p><strong>Shipping Cost:</strong> $${order.shippingCost} ($${(order.shippingCost / order.totalWeight).toFixed(2)}/kg)</p>
        <p><strong>Total Cost:</strong> $${order.totalCost.toLocaleString()}</p>`;
            document.getElementById('OrderDetails-title').textContent = `Order Details - ${order.id}`;
        }

        function renderOrderItems(items) {
            const itemsContainer = document.getElementById('order-Details-Product');
            itemsContainer.innerHTML = items.map(item => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap">${item.name} (${item.id})</td>
            <td class="px-6 py-4 whitespace-nowrap">${item.quantity}</td>
            <td class="px-6 py-4 whitespace-nowrap">$${item.price.toLocaleString()}</td>
            <td class="px-6 py-4 whitespace-nowrap">$${(item.quantity * item.price).toLocaleString()}</td>
        </tr>
    `).join('');
        }


        function renderOrderActions(order) {
            const actionButtons = getActionButtons();
            const visibilityMap = {
                'Wait for confirmation': { confirm: true, process: false, shipping: false, shipped: false, cancel: true },
                'Confirmed': { confirm: false, process: true, shipping: false, shipped: false, cancel: true },
                'Processing': { confirm: false, process: false, shipping: true, shipped: false, cancel: true },
                'Shipping': { confirm: false, process: false, shipping: false, shipped: true, cancel: false },
                'Shipped': { confirm: false, process: false, shipping: false, shipped: false, cancel: false },
                'Cancelled': { confirm: false, process: false, shipping: false, shipped: false, cancel: false }
            };

            const visibility = visibilityMap[order.orderStatus] || visibilityMap['Cancelled'];
            setActionVisibility(actionButtons, visibility);
        }

        function setActionVisibility(actions, visibility) {
            actions.confirmBtn.style.display = visibility.confirm ? 'block' : 'none';
            actions.processingBtn.style.display = visibility.process ? 'block' : 'none';
            actions.shippingBtn.style.display = visibility.shipping ? 'block' : 'none';
            actions.shippedBtn.style.display = visibility.shipped ? 'block' : 'none';
            actions.cancelBtn.style.display = visibility.cancel ? 'block' : 'none';
        }

        function initializeOrderActionButtons() {
            const actionButtons = getActionButtons();
            const statusMap = {
                confirmBtn: 'Confirmed',
                processingBtn: 'Processing',
                shippingBtn: 'Shipping',
                shippedBtn: 'Shipped',
                cancelBtn: 'Cancelled'
            };

            Object.entries(actionButtons).forEach(([key, button]) => {
                button.addEventListener('click', () => {
                    if (key === 'cancelBtn' && !confirm('Are you sure you want to cancel the order?')) {
                        return;
                    }
                    updateOrderStatus(statusMap[key]);
                });
            });
        }

        function getActionButtons() {
            return {
                confirmBtn: document.getElementById('confirmBtn'),
                processingBtn: document.getElementById('processingBtn'),
                shippingBtn: document.getElementById('shippingBtn'),
                shippedBtn: document.getElementById('shippedBtn'),
                cancelBtn: document.getElementById('cancelBtn')
            };
        }

        function updateOrderStatus(status) {
            const orderID = getURLParameter('OrderId');
            const AuthToken = localStorage.getItem('userToken');
            const Api = `../../resources/php/order_api.php?action=updateStatus`;

            return fetch(Api, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${AuthToken}`
                },
                body: JSON.stringify({
                    id: orderID,
                    status: status
                }),
                credentials: "include"
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`Order status updated to ${status} successfully`);
                        window.location.reload();
                    } else {
                        throw new Error(data.message || `Failed to update order status to ${status}`);
                    }
                })
                .catch(error => {
                    console.error(`Error updating order status to ${status}:`, error);
                    alert(error.message);
                });
        }

        function setupEventListeners() {
            document.getElementById('mobileMenuButton').addEventListener('click', toggleMobileMenu);
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            initializeOrderActionButtons();
        }


        function getUrlParameter(name) {
            return new URLSearchParams(window.location.search).get(name);
        }

        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.style.display = mobileMenu.style.display === 'none' ? 'flex' : 'none';
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
        }

        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('orderSummaryDiv').classList.add('hidden');
            document.getElementById('orderActionsDiv').classList.add('hidden');
            document.getElementById('orderItemsDiv').classList.add('hidden');
            document.getElementById('OrderDetails-title').textContent = 'Order Details - Loading...';
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
            document.getElementById('orderSummaryDiv').classList.remove('hidden');
            document.getElementById('orderActionsDiv').classList.remove('hidden');
            document.getElementById('orderItemsDiv').classList.remove('hidden');
        }
    </script>
</head>
<div class="flex h-screen">
    <!-- Navigation -->
    <nav style="display: none; 
border-color: #E5E7EB; 
width: 16rem; 
background-color: #ffffff; 


@media (min-width: 768px) { 
  display: flex; 
flex-direction: column; 
 }">
        <div class="flex flex-col items-center p-4">
            <a class="flex items-center space-x-3 rtl:space-x-reverse mb-6" href="#">
                <div class="h-8 w-8 relative">
                    <img alt="LMC Logo" class="absolute inset-0 object-contain dark:hidden pt-2 dark:pt-1"
                         src="../../resources/image/LMC.png"/>
                    <img alt="LMC Logo" class="absolute inset-0 object-contain hidden dark:block"
                         src="../../resources/image/LMC_DM.png"/>
                </div>
                <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">LMC</span>
            </a>

            <ul class="font-medium flex flex-col space-y-2">
                <li>
                    <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                       href="order.html">Order Record</a>
                </li>
                <li>
                    <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                       href="Item.html">Vehicle</a>
                </li>
                <li>
                    <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                       href="genreport.html">Generate Report</a>
                </li>
                <li>
                    <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                       href="../../logout.html" onclick="logout()">Log Out</a>
                </li>
            </ul>

            <!-- Dark mode toggle button -->
            <button class="mt-6 p-2 text-gray-500 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2
            focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-700"
                    id="darkModeToggle">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z">
                    </path>
                </svg>
            </button>
        </div>
    </nav>

    <!-- Mobile Menu Button -->
    <div class="md:hidden flex items-center justify-between p-4 bg-white dark:bg-gray-900">
        <a href="#" class="flex items-center space-x-3 rtl:space-x-reverse">
            <div class="h-8 w-8 relative">
                <img alt="LMC Logo" class="absolute inset-0 object-contain dark:hidden pt-2 dark:pt-1"
                     src="../../resources/image/LMC.png"/>
                <img alt="LMC Logo" class="absolute inset-0 object-contain hidden dark:block"
                     src="../../resources/image/LMC_DM.png"/>
            </div>
            <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">LMC</span>
        </a>
        <button class="p-2 text-gray-500 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-700"
                id="mobileMenuButton">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                 xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
    </div>

    <!-- Mobile Menu -->
    <!--------------------Menu-------------------->
    <body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-body">
    <div class="md:hidden" id="mobileMenu" style="display: none;">
        <ul class="font-medium flex flex-col space-y-2 p-4 bg-white dark:bg-gray-900">
            <li>
                <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                   href="order.html">Order Record</a>
            </li>
            <li>
                <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                   href="Item.html">Vehicle</a>
            </li>
            <li>
                <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                   href="genreport.html">Generate Report</a>
            </li>
            <li>
                <a class="block py-2 px-3 text-gray-900 rounded hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700"
                   href="../../logout.html" onclick="logout()">Log Out</a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <!--------------------Order-------------------->
    <body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-white">
    <div class="container mx-auto px-4 py-8" id="order">
        <h1 class="text-3xl font-bold mb-6" id="OrderDetails-title">Order Details - SL00008</h1>

        <div class="flex flex-col md:flex-row gap-6">
            <!-- Order Summary -->
            <div class="md:w-1/2">
                <div class="hidden justify-center items-center my-4" id="loadingSpinner">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
                </div>
                <div
                        class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg p-6"
                        id="orderSummaryDiv"
                >
                    <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
                    <div class="grid grid-cols-2 gap-4" id="orderSummary">
                        <!-- it will be rendered by javascript -->
                    </div>
                </div>
            </div>

            <!-- Order Items -->
            <div class="md:w-1/2" id="orderItemsDiv">
                <div
                        class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg"
                >
                    <table
                            class="min-w-full divide-y divide-gray-200 dark:divide-gray-700"
                    >
                        <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
                                    scope="col"
                            >
                                Item
                            </th>
                            <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
                                    scope="col"
                            >
                                Quantity
                            </th>
                            <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
                                    scope="col"
                            >
                                Price
                            </th>
                            <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider"
                                    scope="col"
                            >
                                Total
                            </th>
                        </tr>
                        </thead>
                        <tbody
                                class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700"
                                id="order-Details-Product"
                        >
                        <!-- Product will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Order Actions -->
        <div
                class="mt-8 flex flex-col sm:flex-row justify-between items-center gap-4"
                id="orderActions"
        >
            <a
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded inline-flex items-center"
                    href="order.html"
            >
                <svg
                        class="fill-current w-4 h-4 mr-2"
                        viewBox="0 0 20 20"
                        xmlns="http://www.w3.org/2000/svg"
                >
                    <path
                            d="M10 8.586L2.929 1.515 1.515 2.929 8.586 10l-7.071 7.071 1.414 1.414L10 11.414l7.071 7.071 1.414-1.414L11.414 10l7.071-7.071-1.414-1.414L10 8.586z"
                    />
                </svg>
                <span>Return to Order Records</span>
            </a>
            <div class="flex flex-wrap justify-center sm:justify-end gap-2 hidden" id="orderActionsDiv">
                <button id="confirmBtn"
                        class="bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    Confirm Order
                </button>

                <button id="processingBtn"
                        class="bg-yellow-500 hover:bg-yellow-600 dark:bg-yellow-600 dark:hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-50">
                    Mark as Processing
                </button>

                <button id="shippingBtn"
                        class="bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 text-white font-semibold py-2 px-4 rounded transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                    Ship Order
                </button>

                <button id="shippedBtn"
                        class="bg-purple-500 hover:bg-purple-600 dark:bg-purple-600 dark:hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50">
                    Shipped Order
                </button>

                <button id="cancelBtn"
                        class="bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700 text-white font-semibold py-2 px-4 rounded transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                    Cancel Order
                </button>
            </div>
            <button onclick="printOrder('order')" id="printBtn"
                        class="bg-orange-500 hover:bg-orange-600 dark:bg-orange-600 dark:hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                    Print Order
            </button>
    </body>
</html>